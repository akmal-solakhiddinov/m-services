generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ChatRoom {
  id                 String   @id @default(uuid())
  userOneId          String
  userTwoId          String
  unSeenMessageCount Int      @default(0)
  lastMessageId      String?  @unique

  lastMessage   Message?  @relation("LastMessageInChat", fields: [lastMessageId], references: [id], onDelete: Cascade)
  userOne       User      @relation("UserOneChats", fields: [userOneId], references: [id], onDelete: Cascade)
  userTwo       User      @relation("UserTwoChats", fields: [userTwoId], references: [id], onDelete: Cascade)
  messages      Message[] @relation("ChatMessages")

  @@index([lastMessageId], map: "idx_lastMessage")
  @@index([userOneId], map: "idx_userOneId")
  @@index([userTwoId], map: "idx_userTwoId")
}

model Friends {
  id            String         @id @default(uuid())
  userId        String
  relatedUserId String
  relationshipType Friends_relationshipType
  status        Friends_status
  created       DateTime       @default(now())
  updated       DateTime

  user          User @relation("FriendsAsUser", fields: [userId], references: [id])
  relatedUser   User @relation("FriendsAsRelated", fields: [relatedUserId], references: [id])

  @@unique([userId, relatedUserId])
  @@index([relatedUserId], map: "idx_relatedUserId")
}

model Message {
  id          String         @id @default(uuid())
  content     String?
  file        String?
  fileType    Message_fileType?
  senderId    String
  receiverId  String
  chatId      String
  status      Message_status @default(unseen)
  created     DateTime       @default(now())
  updated     DateTime
  deleted     Boolean        @default(false)

  chatRoom    ChatRoom       @relation("ChatMessages", fields: [chatId], references: [id], onDelete: Cascade)
  lastInChat  ChatRoom?      @relation("LastMessageInChat")
  sender      User           @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User           @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([chatId], map: "idx_chatId")
  @@index([receiverId], map: "idx_receiverId")
  @@index([senderId], map: "idx_senderId")
}

model Request {
  id        String         @id @default(uuid())
  senderId  String
  friendId  String
  status    Request_status @default(pending)
  created   DateTime       @default(now())
  updated   DateTime

  sender    User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  friend    User @relation("ReceivedRequests", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([senderId, friendId])
  @@index([friendId], map: "Request_friendId_fkeyidx")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique @db.VarChar(255)
  ip        String
  device    String
  userAgent String
  created   DateTime @default(now())
  updated   DateTime @updatedAt
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_userId")
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  username      String?    @unique
  fullName      String?
  status        User_status  @default(offline)
  lastLogin     DateTime?
  password      String
  image         String?
  isActivated   Boolean    @default(false)
  created       DateTime   @default(now())
  updated       DateTime
  deleted       Boolean    @default(false)
  account       User_account @default(public)

  userOneChats  ChatRoom[] @relation("UserOneChats")
  userTwoChats  ChatRoom[] @relation("UserTwoChats")

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  friendsAsUser     Friends[] @relation("FriendsAsUser")
  friendsAsRelated  Friends[] @relation("FriendsAsRelated")

  sentRequests     Request[] @relation("SentRequests")
  receivedRequests Request[] @relation("ReceivedRequests")

  sessions         Session[]

  @@index([email], map: "idx_email")
  @@index([id], map: "idx_id")
  @@index([username], map: "idx_username")
}

enum Request_status {
  pending
  approved
  rejected
}

enum Message_fileType {
  IMAGE
  VIDEO
  FILE
  AUDIO
}

enum Friends_relationshipType {
  friend
  blocked
}

enum User_status {
  online
  offline
}

enum Friends_status {
  active
  removed
}

enum Message_status {
  seen
  unseen
}

enum User_account {
  private
  public
}
